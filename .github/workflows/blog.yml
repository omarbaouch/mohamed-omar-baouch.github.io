name: Generate Daily Blog Content

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'  # Radar article every day at 7am UTC
    - cron: '0 12 * * *' # Keyword article every day at 12pm UTC

permissions:
  contents: write

jobs:
  daily-radar:
    # This job runs for the daily 7am cron or manual dispatch
    if: github.event.schedule == '0 7 * * *' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Pull latest changes immediately after checkout
      - name: Pull latest changes
        run: git pull --rebase

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache models
        uses: actions/cache@v4
        with:
          path: ~/.cache
          key: transformers-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: transformers-cache-${{ runner.os }}-

      # 2. Now, run the scripts that modify files
      - name: Collect items
        run: npm run build-blog -- --items-only

      - name: Enrich items with local AI and Images
        run: npm run enrich-blog

      - name: Generate blog pages
        run: npm run build-blog

      # 3. Finally, commit the new changes
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'üì∞ chore(blog): update daily radar with summaries and images'
          file_pattern: |
            blog
            blog_meta
            .cache
            history.json

  keyword-post:
    # This job runs for the daily 12pm cron or manual dispatch
    if: github.event.schedule == '0 12 * * *' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Pull latest changes immediately after checkout
      - name: Pull latest changes
        run: git pull --rebase

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        
      # 2. Run the script (with the corrected path)
      - name: Generate keyword-based article
        run: node generate-keyword-post.mjs

      # 3. Finally, commit the new changes
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '‚úçÔ∏è feat(blog): add new daily keyword-based article'
          file_pattern: |
            blog
            keywords.json
